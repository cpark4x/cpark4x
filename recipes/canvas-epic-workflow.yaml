# Canvas Epic Development Workflow
# ==================================
# Staged workflow for Canvas epic development following outcome-driven principles.
#
# Stages:
#   1. ANALYZE - Break down epic into user stories with outcome definitions
#   2. DESIGN - Architecture design with Canvas philosophy review
#   3. IMPLEMENT - Code generation with verification checkpoints
#   4. VERIFY - Tests, LSP, and philosophy compliance
#   5. DOCUMENT - Update epic with implementation details
#
# Usage:
#   amplifier recipes execute git+https://github.com/cpark4x/cpark4x@main:recipes/canvas-epic-workflow.yaml \
#     --context '{"epic_number": "12", "epic_name": "my-epic", "epic_path": "docs/02-requirements/epics/12-my-epic.md"}'

name: "canvas-epic-workflow"
description: "Complete Canvas epic development with outcome-driven analysis, design, implementation, and verification"
version: "1.0.0"
author: "cpark4x"
tags: ["canvas", "epic", "outcome-driven", "verification"]

context:
  # Required: Epic number (e.g., "12")
  epic_number: ""
  
  # Required: Epic name (e.g., "my-epic")
  epic_name: ""
  
  # Required: Path to epic document
  epic_path: ""
  
  # Optional: Specific story to implement (if not implementing full epic)
  story_name: ""

# ============================================================================
# STAGE 1: ANALYZE
# ============================================================================
# Read epic, understand requirements, break down into implementable stories

stages:
  - name: "analyze"
    steps:
      - id: "read-epic"
        agent: "foundation:explorer"
        prompt: |
          Analyze the Canvas epic and understand the requirements.
          
          Epic Path: {{epic_path}}
          Project Root: ~/amplifier.workspaces2
          
          Tasks:
          1. Read the epic document
          2. Understand the problem statement and goals
          3. Identify all user stories (if any are defined)
          4. Note dependencies and integration points
          5. Check related files (CLAUDE.md, ITERATION_PHILOSOPHY.md)
          
          Provide comprehensive epic summary.
        output: "epic_analysis"
        timeout: 900

      - id: "break-down-stories"
        agent: "foundation:zen-architect"
        prompt: |
          Break down the epic into implementable user stories.
          
          Epic Analysis:
          {{epic_analysis}}
          
          Following Canvas templates (docs/07-templates/), create user stories that:
          
          For each story:
          ## User Story: [Name]
          
          **As a** [role]
          **I want to** [action]
          **So that** [outcome]
          
          **Outcome Definition:**
          - Success looks like: [specific, measurable outcome]
          - User can: [concrete capabilities]
          - System ensures: [guarantees/constraints]
          
          **Acceptance Criteria:**
          1. [Testable criterion]
          2. [Testable criterion]
          
          **Technical Scope:**
          - Frontend: [components/pages]
          - Backend: [endpoints/services]
          - Database: [models/migrations if needed]
          
          **Dependencies:**
          - Requires: [other stories/features]
          - Blocks: [future work]
          
          Prioritize by implementation order.
        output: "user_stories"
        timeout: 1200

      - id: "select-story"
        agent: "foundation:zen-architect"
        prompt: |
          Determine which story to implement.
          
          User Stories:
          {{user_stories}}
          
          Context:
          - Story specified: {{story_name}}
          - If no story specified, recommend starting with foundation/infrastructure story
          
          Output:
          1. Selected story name
          2. Rationale for selection
          3. Prerequisites (what must exist first)
        output: "selected_story"
        timeout: 300


  # ============================================================================
  # STAGE 2: DESIGN
  # ============================================================================
  # Architecture design following Canvas patterns

  - name: "design"
    steps:
      - id: "analyze-codebase"
        agent: "foundation:explorer"
        prompt: |
          Survey the Canvas codebase for relevant patterns.
          
          Selected Story:
          {{selected_story}}
          
          Project: ~/amplifier.workspaces2
          
          Find:
          1. Similar features (frontend/backend patterns)
          2. Shared components and utilities
          3. API patterns and conventions
          4. Database model patterns
          5. Test patterns
          
          Focus on:
          - frontend/src/components/
          - frontend/src/pages/
          - backend/app/
          - Existing tests
        output: "codebase_patterns"
        timeout: 900

      - id: "design-architecture"
        agent: "foundation:zen-architect"
        prompt: |
          Design the implementation architecture.
          
          Story:
          {{selected_story}}
          
          Codebase Patterns:
          {{codebase_patterns}}
          
          Create design following Canvas principles:
          
          ## 1. Outcome Definition
          - What does success look like?
          - How will we verify it works?
          
          ## 2. Component Architecture
          - Frontend components (reuse existing patterns)
          - Backend endpoints (follow FastAPI patterns)
          - Database changes (if needed)
          - Integration points
          
          ## 3. Data Flow
          - User interaction â†’ Frontend â†’ Backend â†’ Database
          - State management (Zustand patterns)
          - Error handling
          
          ## 4. File Structure
          ```
          frontend/
            src/
              components/[new-components]
              pages/[new-pages]
          backend/
            app/
              api/v1/endpoints/[new-endpoints]
              models/[new-models]
              services/[new-services]
          ```
          
          ## 5. Verification Plan
          - Unit tests
          - Integration tests
          - Manual verification steps
          
          ## 6. Canvas Philosophy Check
          - Is this the simplest solution?
          - Are we building for the outcome, not just output?
          - Can this be verified incrementally?
          
          Keep it simple. Reuse existing patterns.
        output: "design_doc"
        timeout: 1200

    approval:
      required: true
      prompt: |
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                            DESIGN REVIEW REQUIRED
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        Epic: {{epic_name}}
        Story: {{selected_story}}
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        
        DESIGN:
        {{design_doc}}
        
        CODEBASE PATTERNS FOUND:
        {{codebase_patterns}}
        
        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        
        â†’ APPROVE: Proceed with implementation
        â†’ DENY: Revise design manually
      timeout: 0
      default: "deny"


  # ============================================================================
  # STAGE 3: IMPLEMENT
  # ============================================================================
  # Build the feature with verification checkpoints

  - name: "implement"
    steps:
      - id: "implement-backend"
        agent: "foundation:modular-builder"
        prompt: |
          Implement the backend components.
          
          Design:
          {{design_doc}}
          
          Project: ~/amplifier.workspaces2/backend
          
          Follow Canvas patterns:
          - FastAPI endpoint patterns (see app/api/v1/endpoints/)
          - Pydantic models for validation
          - Service layer for business logic
          - Database models if needed (SQLAlchemy)
          
          Create:
          1. API endpoints (app/api/v1/endpoints/)
          2. Pydantic schemas (app/schemas/)
          3. Services (app/services/)
          4. Models if needed (app/models/)
          
          Include:
          - Type hints
          - Docstrings
          - Error handling
          - Input validation
          
          Do not:
          - Add speculative features
          - Over-abstract
          - Skip error cases
        output: "backend_result"
        timeout: 1800

      - id: "implement-frontend"
        agent: "foundation:modular-builder"
        prompt: |
          Implement the frontend components.
          
          Design:
          {{design_doc}}
          
          Backend Implementation:
          {{backend_result}}
          
          Project: ~/amplifier.workspaces2/frontend
          
          Follow Canvas patterns:
          - React functional components with TypeScript
          - Zustand for state management
          - Tailwind CSS for styling
          - shadcn/ui components
          
          Create:
          1. Components (src/components/)
          2. Pages if needed (src/pages/)
          3. Store hooks if needed (src/store/)
          4. API integration (src/services/)
          
          Include:
          - TypeScript types
          - PropTypes documentation
          - Accessible UI (ARIA labels)
          - Loading and error states
          
          Do not:
          - Reinvent existing components
          - Add unnecessary animations
          - Skip loading/error states
        output: "frontend_result"
        timeout: 1800


  # ============================================================================
  # STAGE 4: VERIFY
  # ============================================================================
  # Test, validate, and ensure philosophy compliance

  - name: "verify"
    steps:
      - id: "run-backend-tests"
        agent: "foundation:zen-architect"
        prompt: |
          Test the backend implementation.
          
          Backend Implementation:
          {{backend_result}}
          
          Project: ~/amplifier.workspaces2/backend
          
          Tasks:
          1. Run pytest on new endpoints
          2. Check test coverage
          3. Verify API responses match schemas
          4. Test error cases
          
          Commands:
          cd ~/amplifier.workspaces2/backend
          pytest tests/ -v
          
          Report results.
        output: "backend_tests"
        timeout: 900
        on_error: "continue"

      - id: "run-frontend-checks"
        agent: "foundation:zen-architect"
        prompt: |
          Check the frontend implementation.
          
          Frontend Implementation:
          {{frontend_result}}
          
          Project: ~/amplifier.workspaces2/frontend
          
          Tasks:
          1. TypeScript compilation (npm run type-check)
          2. Linting (npm run lint)
          3. Build check (npm run build)
          4. Component tests if they exist
          
          Report any errors or warnings.
        output: "frontend_checks"
        timeout: 900
        on_error: "continue"

      - id: "manual-verification"
        agent: "foundation:zen-architect"
        prompt: |
          Create manual verification checklist.
          
          Story:
          {{selected_story}}
          
          Design:
          {{design_doc}}
          
          Create step-by-step verification:
          
          ## Manual Verification Checklist
          
          ### Setup
          1. Start dev environment: cd ~/amplifier.workspaces2 && ./start-dev.sh
          2. Navigate to: http://localhost:5173/[relevant-path]
          
          ### Test Cases
          For each acceptance criterion:
          - [ ] [Test step]
          - [ ] [Expected behavior]
          - [ ] [Verification method]
          
          ### Edge Cases
          - [ ] [Edge case test]
          - [ ] [Error handling test]
          
          ### Outcome Verification
          - [ ] Does this achieve the defined outcome?
          - [ ] Can user accomplish their goal?
          
          Make it easy to copy-paste and check off.
        output: "verification_checklist"
        timeout: 600

      - id: "philosophy-review"
        agent: "foundation:zen-architect"
        prompt: |
          Review against Canvas philosophy.
          
          Story: {{selected_story}}
          Design: {{design_doc}}
          Backend: {{backend_result}}
          Frontend: {{frontend_result}}
          
          Check against Canvas principles:
          
          ## 1. Outcome-Driven
          âœ“/âœ— Does this solve the user's actual problem?
          âœ“/âœ— Is success measurable?
          âœ“/âœ— Did we avoid building extra features?
          
          ## 2. Verification-First
          âœ“/âœ— Can we verify each piece works?
          âœ“/âœ— Are tests meaningful?
          âœ“/âœ— Is there a clear verification path?
          
          ## 3. Simplicity
          âœ“/âœ— Simplest solution for the outcome?
          âœ“/âœ— Any unnecessary abstractions?
          âœ“/âœ— Following existing patterns?
          
          ## 4. Quality
          âœ“/âœ— Type-safe?
          âœ“/âœ— Error handling complete?
          âœ“/âœ— Accessible UI?
          
          Rate: 1-10 and provide specific recommendations.
        output: "philosophy_review"
        timeout: 600


  # ============================================================================
  # STAGE 5: DOCUMENT
  # ============================================================================
  # Update epic with implementation details

  - name: "document"
    steps:
      - id: "generate-summary"
        agent: "foundation:zen-architect"
        prompt: |
          Generate implementation summary for the epic.
          
          Epic: {{epic_name}}
          Story: {{selected_story}}
          Design: {{design_doc}}
          Backend: {{backend_result}}
          Frontend: {{frontend_result}}
          Tests: {{backend_tests}}
          Checks: {{frontend_checks}}
          Review: {{philosophy_review}}
          
          Create summary:
          
          ## Implemented: [Story Name]
          
          **Status:** âœ… Complete | ğŸš§ In Progress | âš ï¸ Needs Work
          
          **Outcome Achieved:**
          [What the user can now do]
          
          **Implementation:**
          - Backend: [endpoints created]
          - Frontend: [components created]
          - Tests: [coverage summary]
          
          **Files Changed:**
          ```
          backend/
            app/api/v1/endpoints/[...]
            app/schemas/[...]
          frontend/
            src/components/[...]
          ```
          
          **Verification:**
          {{verification_checklist}}
          
          **Follow-up:**
          - [ ] [Any remaining tasks]
          - [ ] [Technical debt notes]
          
          **Philosophy Score:** [X/10]
          [Key insights from philosophy review]
          
          Format for adding to epic document.
        output: "implementation_summary"
        timeout: 600

      - id: "update-epic"
        agent: "foundation:zen-architect"
        prompt: |
          Update the epic document with implementation details.
          
          Epic Path: {{epic_path}}
          Summary: {{implementation_summary}}
          
          Tasks:
          1. Read current epic document
          2. Add implementation summary to appropriate section
          3. Update story status (if stories section exists)
          4. Add to "Implemented Features" section
          5. Update epic status if all stories complete
          
          Follow Canvas epic template format.
        output: "epic_updated"
        timeout: 600

      - id: "final-output"
        agent: "foundation:zen-architect"
        prompt: |
          Generate final workflow output.
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          CANVAS EPIC WORKFLOW COMPLETE
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          Epic: {{epic_name}}
          Story: {{selected_story}}
          
          SUMMARY:
          {{implementation_summary}}
          
          NEXT STEPS:
          1. Review verification checklist
          2. Manual testing: {{verification_checklist}}
          3. Commit changes: git add . && git commit -m "feat: [story name]"
          4. Consider next story from: {{user_stories}}
          
          PHILOSOPHY SCORE: [from {{philosophy_review}}]
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        output: "final_report"
        timeout: 300
